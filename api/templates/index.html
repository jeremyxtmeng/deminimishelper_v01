<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>De Minimis Helper</title>

  <link rel="stylesheet" href="index.css" />

</head>
<body>

  <!-- Top navigation -->
  <header
    class="top-nav"
    style="
      justify-content: flex-start;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
      padding-bottom: 0.75rem;
    "
  >
    <h1
      style="
        font-size: 1.35rem;
        font-weight: 650;
        letter-spacing: 0.08em;
        text-transform: captalize;
        color: var(--text-main);
      "
    >
      De Minimis Helper
    </h1>
    <p
      style="
        font-size: 0.95rem;
        color: var(--text-muted);
        opacity: 0.9;
      "
    >
      Empowering global small exporters and importers
    </p>
  </header>

  <!-- Key functions, softly blended into the background -->
  <section
    style="
      max-width: 1200px;
      margin: 0 auto 1.75rem;
      padding: 0 1.5rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem 1.1rem;
      align-items: center;
    "
  >
    <div
      style="
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.6rem 1.1rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.45);
        border: 1px solid rgba(209, 213, 219, 0.8);
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.05);
        backdrop-filter: blur(10px);
        font-size: 0.9rem;
        color: var(--text-muted);
      "
    >
      <span
        style="
          width: 28px;
          height: 28px;
          border-radius: 999px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          background: rgba(255, 122, 26, 0.12);
          border: 1px solid rgba(248, 113, 22, 0.3);
          font-size: 1.05rem;
        "
        aria-hidden="true"
      >
        ðŸ§®
      </span>
      <span>Tariff Engineering</span>
    </div>

    <div
      style="
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.6rem 1.1rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.45);
        border: 1px solid rgba(209, 213, 219, 0.8);
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.05);
        backdrop-filter: blur(10px);
        font-size: 0.9rem;
        color: var(--text-muted);
      "
    >
      <span
        style="
          width: 28px;
          height: 28px;
          border-radius: 999px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          background: rgba(56, 189, 248, 0.12);
          border: 1px solid rgba(59, 130, 246, 0.3);
          font-size: 1.05rem;
        "
        aria-hidden="true"
      >
        ðŸ’±
      </span>
      <span>Trade &amp; Finance Optimization</span>
    </div>

    <div
      style="
        display: flex;
        align-items: center;
        gap: 0.6rem;
        padding: 0.6rem 1.1rem;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.45);
        border: 1px solid rgba(209, 213, 219, 0.8);
        box-shadow: 0 10px 25px rgba(15, 23, 42, 0.05);
        backdrop-filter: blur(10px);
        font-size: 0.9rem;
        color: var(--text-muted);
      "
    >
      <span
        style="
          width: 28px;
          height: 28px;
          border-radius: 999px;
          display: inline-flex;
          align-items: center;
          justify-content: center;
          background: rgba(52, 211, 153, 0.12);
          border: 1px solid rgba(16, 185, 129, 0.3);
          font-size: 1.05rem;
        "
        aria-hidden="true"
      >
        ðŸ“¦
      </span>
      <span>Supply Chain Forecasts</span>
    </div>
  </section>


  <!-- Main hero content -->
  <main>
    <section class="hero">
      <h1 class="hero-title">Goods Classification and Market Intelligence</h1>
      <p class="hero-subtitle">
        AI-assisted classifications and report generations
      </p>

      <!-- Prompt card -->
      <form class="prompt-card" id="prompt-form">
        <label for="prompt-input" class="sr-only" id="prompt-label">
          This pilot version is limited to medical devices. Describe ONE medical device/equipment...
        </label>
        <textarea
          id="prompt-input"
          class="prompt-textarea"
          placeholder="This pilot version is only limited to medical devices. Describe ONE medical device/equipment..."
          required
        ></textarea>

        <div class="card-footer">   
        <!--
          <div class="model-pill">
            <span class="model-dot"></span>
            <span>Data source</span>
          </div>
        -->
          <span></span><button type="submit" class="submit-btn" aria-label="Send prompt"></span>
            âžœ
          </button>
        </div>
      </form>

      <!-- Response preview -->
      <section class="response-section hidden" id="response-section">
        <div class="response-title">Response</div>
        <div class="response-card">
          <div class="response-content" id="response-content"></div>
        </div>
      </section>

      <!-- Idea chips -->
      <div class="ideas-row" id="ideas-row">
        <span class="ideas-label">Goods to get started</span>
        <button class="chip" type="button">
          Wheelchairs
        </button>
        <button class="chip" type="button">
          MRI Machines
        </button>
        <button class="chip" type="button">
          Stethoscopes
        </button>
      </div>

      <!-- How It Works (directly under Goods to get started) -->
      <section class="how-it-works">
        <h2 class="how-title">How It Works</h2>
      
        <div class="how-grid">
          <!-- Step 1 -->
          <article class="how-card">
            <div class="how-card-head">
              <div class="how-step-badge">1</div>
              <h3 class="how-card-title">Describe Your Product</h3>
            </div>
            <p class="how-card-text">
              Enter a short description.
            </p>
          </article>
        
          <!-- Step 2 -->
          <article class="how-card">
            <div class="how-card-head">
              <div class="how-step-badge">2</div>
              <h3 class="how-card-title">Validate &amp; Classify</h3>
            </div>
            <p class="how-card-text">
              HS code assigned. Tell us your sourcing country and a future date.
            </p>
          </article>
        
          <!-- Step 3 -->
          <article class="how-card">
            <div class="how-card-head">
              <div class="how-step-badge">3</div>
              <h3 class="how-card-title">Get Tariffs &amp; Supply Chain Info</h3>
            </div>
            <p class="how-card-text">
              We will create a report on current trade policy and import demand forecasts.
            </p>
          </article>
        </div>
      </section>

    </section>
  </main>


   <footer class="site-footer">
       <span>Â© 2025 De Minimis Helper. Created by Economist with Love. All rights reserved. Click <a href="https://github.com/jeremyxtmeng/deminimishelper_v01.git" target="_blank" rel="noopener noreferrer">
        here</a> for the Github repo. </span> <span class="heart-icon">ðŸ§¡</span>
  </footer>




  
<script>
  const CLASSIFY_API_URL = "/api/medical-classify";
  const TRADE_API_URL = "/api/trade-info";

  let hasSubmittedOnce = false;
  let awaitingCountry = false;
  let currentHs10 = null;

  function escapeHTML(str) {
    return String(str).replace(/[&<>"']/g, function (m) {
      switch (m) {
        case "&":
          return "&amp;";
        case "<":
          return "&lt;";
        case ">":
          return "&gt;";
        case '"':
          return "&quot;";
        default:
          return "&#39;";
      }
    });
  }

  const form = document.getElementById("prompt-form");
  const textarea = document.getElementById("prompt-input");
  const label = document.getElementById("prompt-label");
  const responseSection = document.getElementById("response-section");
  const responseContent = document.getElementById("response-content");
  const ideasRow = document.getElementById("ideas-row");
  const chips = document.querySelectorAll(".chip");

  // Fill textarea from idea chips
  chips.forEach((chip) => {
    chip.addEventListener("click", () => {
      const idea = chip.textContent.trim();
      textarea.value = idea;
      textarea.focus();
    });
  });

  // Helper: generic POST + safe JSON parsing
  async function postJson(url, payload) {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });

    const rawText = await res.text();
    console.log("[postJson] URL:", url, "status:", res.status, "raw:", rawText);

    let data = {};
    if (rawText) {
      try {
        data = JSON.parse(rawText);
      } catch (err) {
        console.error("[postJson] JSON parse error:", err);
        throw new Error(
          "Backend returned a non-JSON response. See console or server logs."
        );
      }
    }

    return { res, data };
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const prompt = textarea.value.trim();
    if (!prompt) return;

    responseSection.classList.remove("hidden");

    // If we're waiting for a country, go to trade-info endpoint
    if (awaitingCountry && currentHs10) {
      responseContent.innerHTML =
        "<em>Checking trade policy and supply chainâ€¦</em>";
      await handleTradeInfo(prompt);
      return;
    }

    // Otherwise, normal classification step
    responseContent.innerHTML = "<em>Validating your descriptionâ€¦</em>";

    // After first submit: hide chips + change prompt card text
    if (!hasSubmittedOnce) {
      hasSubmittedOnce = true;
      if (ideasRow) ideasRow.classList.add("hidden");

      textarea.value = "";
      textarea.placeholder ="Enter a country name and a date...";
      //textarea.placeholder =  "Describe another medical device or ask a follow-up questionâ€¦";
      if (label) {
        label.textContent = "Describe your requestâ€¦";
      }
    }

    try {
      const { res, data } = await postJson(CLASSIFY_API_URL, { prompt });

      if (!res.ok || !data.ok) {
        const msg =
          (data && data.message) ||
          "Your input does not look like a description of ONE medical device. Please try again.";
        responseContent.innerHTML =
          "<p><strong>Notice</strong></p><p>" + escapeHTML(msg) + "</p>";

        // Reset to product stage on error
        awaitingCountry = false;
        currentHs10 = null;
        return;
      }

      // ---- Render classification response ----
      const hs10 = data.hs10 != null ? String(data.hs10) : "N/A";
      const labelText = data.label || "No label returned";
      const extra = data.extra || {};
      const validatorReason = data.validator_reason || "";
      const message = data.message || "";
      const followupPrompt = data.followup_prompt || "";

      let extraHtml = "";
      if (extra && typeof extra === "object" && Object.keys(extra).length > 0) {
        extraHtml =
          "<ul style='margin-top:0.4rem;padding-left:1.1rem;font-size:0.9rem;'>" +
          Object.entries(extra)
            .map(
              ([k, v]) =>
                "<li><strong>" +
                escapeHTML(k) +
                ":</strong> " +
                escapeHTML(String(v)) +
                "</li>"
            )
            .join("") +
          "</ul>";
      }

      let html =
        "<p><strong>Classification result</strong></p>" +
        "<p><strong>HS10:</strong> " +
        escapeHTML(hs10) +
        "<br/><strong>Description:</strong> " +
        escapeHTML(labelText) +
        "</p>";

      if (validatorReason) {
        html +=
          "<p style='margin-top:0.6rem;font-size:0.9rem;color:#6b7280;'><strong>Validator:</strong> " +
          escapeHTML(validatorReason) +
          "</p>";
      }

      html += extraHtml;

      if (message) {
        html +=
          "<p style='margin-top:0.75rem;'>" + escapeHTML(message) + "</p>";
      }

      if (followupPrompt) {
        html +=
          "<p style='margin-top:0.5rem;font-style:italic;'>" +
          escapeHTML(followupPrompt) +
          "</p>";
      }

      responseContent.innerHTML = html;

      // If there's a followup_prompt, go into "awaiting country" mode
      if (followupPrompt && data.hs10 != null) {
        awaitingCountry = true;
        currentHs10 = data.hs10;
      } else {
        awaitingCountry = false;
        currentHs10 = null;
      }
    } catch (err) {
      console.error("[CLASSIFY] Network or JS error:", err);
      responseContent.innerHTML =
        "<span style='color:#b91c1c'>Error contacting the backend. Please try again later.</span>";
      awaitingCountry = false;
      currentHs10 = null;
    }
  });

  async function handleTradeInfo(prompt) {
    try {
      const { res, data } = await postJson(TRADE_API_URL, {
        prompt,
        hs10: currentHs10,
      });

      if (!res.ok || !data.ok) {
        const msg =
          (data && data.message) ||
          "Sorry, I couldn't process your request. Please enter the description of another product.";
        responseContent.innerHTML =
          "<p><strong>Notice</strong></p><p>" + escapeHTML(msg) + "</p>";

        // If backend says reset_to_product, go back to initial stage
        if (data && data.reset_to_product) {
          awaitingCountry = false;
          currentHs10 = null;
        }
        return;
      }

      const msg = data.message || "Trade information retrieved.";
      const dashboardUrl = data.dashboard_url || null;

      let html =
        "<p><strong>Trade &amp; Tariff Information</strong></p>" +
        "<p>" + escapeHTML(msg) + "</p>";

      if (dashboardUrl) {
        html +=
          '<p><a href="' +
          escapeHTML(dashboardUrl) +
          '" target="_blank" rel="noopener noreferrer">' +
          escapeHTML(dashboardUrl) +
          "</a></p>";
      }

      responseContent.innerHTML = html;

      // Backend tells us to reset to product description stage
      if (data.reset_to_product) {
        awaitingCountry = false;
        currentHs10 = null;
      }
    } catch (err) {
      console.error("[TRADE] Network or JS error:", err);
      responseContent.innerHTML =
        "<span style='color:#b91c1c'>Error contacting the backend for trade info.</span>";
      awaitingCountry = false;
      currentHs10 = null;
    }
  }
</script>
</body>
</html>
